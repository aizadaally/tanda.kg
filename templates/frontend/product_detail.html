{% extends 'base.html' %}

{% block title %}{{ product.name }} - Tanda.kg{% endblock %}

{% block content %}
<!-- Add CSRF token for AJAX -->
{% csrf_token %}

<section class="py-4">
    <div class="container">
        <!-- Breadcrumb -->
        <nav aria-label="breadcrumb" class="mb-4">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'home' %}">Главная</a></li>
                <li class="breadcrumb-item"><a href="{% url 'products' %}">Каталог</a></li>
                <li class="breadcrumb-item"><a href="{% url 'products' %}?category={{ product.category.slug }}">{{ product.category.name }}</a></li>
                <li class="breadcrumb-item active">{{ product.name }}</li>
            </ol>
        </nav>

        <div class="row">
            <!-- Product Images -->
            <div class="col-md-6 mb-4">
                <div class="product-gallery">
                    {% if product.image %}
                        <img src="{{ product.image.url }}" 
                             class="img-fluid rounded shadow-sm" 
                             alt="{{ product.name }}"
                             style="width: 100%; height: 400px; object-fit: cover;">
                    {% else %}
                        <div class="bg-light rounded d-flex align-items-center justify-content-center shadow-sm" 
                             style="height: 400px;">
                            <i class="bi bi-image text-muted" style="font-size: 4rem;"></i>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Product Info -->
            <div class="col-md-6">
                <div class="product-info">
                    <!-- Producer Info -->
                    <div class="mb-3">
                        <a href="{% url 'producer_detail' product.producer.pk %}" class="text-decoration-none">
                            <div class="d-flex align-items-center">
                                {% if product.producer.logo %}
                                    <img src="{{ product.producer.logo.url }}" 
                                         class="rounded-circle me-2" 
                                         width="40" height="40"
                                         alt="{{ product.producer.name }}">
                                {% else %}
                                    <div class="bg-light rounded-circle me-2 d-flex align-items-center justify-content-center" 
                                         style="width: 40px; height: 40px;">
                                        <i class="bi bi-shop"></i>
                                    </div>
                                {% endif %}
                                <div>
                                    <h6 class="mb-0">{{ product.producer.name }}</h6>
                                    <small class="text-muted">{{ product.producer.get_region_display }}</small>
                                    {% if product.producer.is_verified %}
                                        <i class="bi bi-patch-check-fill text-primary ms-1" title="Проверенный производитель"></i>
                                    {% endif %}
                                </div>
                            </div>
                        </a>
                    </div>

                    <!-- Product Name -->
                    <h1 class="h2 mb-3">{{ product.name }}</h1>

                    <!-- Category -->
                    <div class="mb-3">
                        <span class="badge bg-light text-dark">
                            <i class="bi bi-{{ product.category.icon|default:'tag' }}"></i> {{ product.category.name }}
                        </span>
                    </div>

                    <!-- Rating -->
                    {% if product.total_reviews > 0 %}
                    <div class="mb-3">
                        <div class="d-flex align-items-center">
                            <div class="text-warning me-2">
                                {% with rating=product.average_rating %}
                                    {% for i in "12345" %}
                                        {% if forloop.counter <= rating %}
                                            <i class="bi bi-star-fill"></i>
                                        {% else %}
                                            <i class="bi bi-star"></i>
                                        {% endif %}
                                    {% endfor %}
                                {% endwith %}
                            </div>
                            <span class="text-muted">{{ product.average_rating|floatformat:1 }} ({{ product.total_reviews }} отзывов)</span>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Price -->
                    <div class="mb-4">
                        <h3 class="text-primary mb-0">{{ product.price|floatformat:0 }} сом</h3>
                        {% if product.num_sales > 0 %}
                            <small class="text-muted">Куплено: {{ product.num_sales }} раз</small>
                        {% endif %}
                    </div>

                    <!-- Description -->
                    <div class="mb-4">
                        <h5>Описание</h5>
                        <p class="text-muted">{{ product.description|linebreaks }}</p>
                    </div>

                    <!-- Purchase Options -->
                    <div class="purchase-section">
                        <!-- Quantity Selector -->
                        <div class="mb-3">
                            <label class="form-label">Количество:</label>
                            <div class="d-flex align-items-center">
                                <button type="button" class="btn btn-outline-secondary" onclick="decreaseQuantity()">
                                    <i class="bi bi-dash"></i>
                                </button>
                                <input type="number" id="quantity" class="form-control mx-2 text-center" value="1" min="1" style="width: 80px;" onchange="updateTotal()">
                                <button type="button" class="btn btn-outline-secondary" onclick="increaseQuantity()">
                                    <i class="bi bi-plus"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Total Price -->
                        <div class="mb-3">
                            <h5>Итого: <span id="totalPrice" class="text-primary">{{ product.price|floatformat:0 }}</span> сом</h5>
                        </div>

                        <!-- Buy Buttons -->
                        <div class="d-grid gap-2 mb-3">
                            {% if user.is_authenticated %}
                                <!-- Add to Cart Button -->
                                <button type="button" 
                                        class="btn btn-outline-primary-custom btn-lg"
                                        onclick="addToCartFromDetail()">
                                    <i class="bi bi-bag-plus"></i> Добавить в корзину
                                </button>
                                
                                <!-- QR Purchase Button -->
                                {% if product.producer.qr_code %}
                                <button type="button" 
                                        class="btn btn-primary-custom btn-lg" 
                                        data-bs-toggle="modal" 
                                        data-bs-target="#purchaseModal">
                                    <i class="bi bi-qr-code-scan"></i> Купить через QR-код
                                </button>
                                {% endif %}
                            {% else %}
                                <a href="{% url 'login' %}?next={{ request.path }}" class="btn btn-primary-custom btn-lg">
                                    <i class="bi bi-box-arrow-in-right"></i> Войти для покупки
                                </a>
                            {% endif %}
                            
                            <!-- Favorite Button -->
                            <button type="button" 
                                    class="btn btn-outline-secondary" 
                                    onclick="toggleFavoriteLocal({{ product.id }})">
                                <i class="bi bi-heart" id="favorite-icon"></i> В избранное
                            </button>
                        </div>

                        <!-- Contact Producer -->
                        <div class="mt-3">
                            <div class="card">
                                <div class="card-body text-center">
                                    <h6 class="card-title">Есть вопросы?</h6>
                                    <div class="d-grid gap-2">
                                        {% if product.producer.whatsapp_number %}
                                            <a href="https://wa.me/{{ product.producer.whatsapp_number }}?text=Здравствуйте! Интересует товар: {{ product.name }} - {{ product.price|floatformat:0 }} сом.%0AСсылка: {{ request.build_absolute_uri }}" 
                                               target="_blank" 
                                               class="btn btn-success">
                                                <i class="bi bi-whatsapp"></i> WhatsApp
                                            </a>
                                        {% endif %}
                                        
                                        {% if product.producer.phone_number %}
                                            <a href="tel:{{ product.producer.phone_number }}" 
                                               class="btn btn-outline-primary">
                                                <i class="bi bi-phone"></i> {{ product.producer.phone_number }}
                                            </a>
                                        {% endif %}
                                        
                                        {% if not product.producer.whatsapp_number and not product.producer.phone_number %}
                                            <p class="text-muted mb-0">Контакты не указаны</p>
                                            <small class="text-muted">Производитель может добавить контакты в профиле</small>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Producer QR Code Modal -->
{% if product.producer.qr_code %}
<div class="modal fade" id="purchaseModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-qr-code-scan text-primary"></i> Оплата через QR-код
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <div class="mb-3">
                    <img src="{{ product.producer.qr_code.url }}" 
                         class="img-fluid border rounded" 
                         alt="QR код для оплаты"
                         style="max-width: 250px;">
                </div>
                <h6>{{ product.producer.name }}</h6>
                <p class="text-muted mb-3">
                    Отсканируйте QR-код через приложение вашего банка
                </p>
                
                <!-- Order Summary -->
                <div class="border rounded p-3 mb-3 bg-light">
                    <div class="d-flex justify-content-between">
                        <span>{{ product.name }}</span>
                        <span>{{ product.price|floatformat:0 }} сом</span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>Количество:</span>
                        <span id="modalQuantity">1</span>
                    </div>
                    <hr class="my-2">
                    <div class="d-flex justify-content-between fw-bold">
                        <span>Итого:</span>
                        <span id="modalTotal">{{ product.price|floatformat:0 }} сом</span>
                    </div>
                </div>

                <!-- Payment Instructions -->
                <div class="alert alert-info text-start">
                    <small>
                        <strong>Как оплатить:</strong><br>
                        1. Откройте приложение банка (MBank, Оптима, Демир и др.)<br>
                        2. Выберите "Оплата по QR" или "Сканер"<br>
                        3. Отсканируйте код выше<br>
                        4. Укажите сумму: <strong id="paymentAmount">{{ product.price|floatformat:0 }} сом</strong><br>
                        5. Подтвердите оплату
                    </small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-success" onclick="markAsPurchased()">
                    <i class="bi bi-check-circle"></i> Я оплатил
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
            </div>
        </div>
    </div>
</div>
{% endif %}

<script>
const basePrice = {{ product.price }};

function updateTotal() {
    const quantity = parseInt(document.getElementById('quantity').value) || 1;
    const total = basePrice * quantity;
    document.getElementById('totalPrice').textContent = total.toFixed(0);
    
    // Update modal if it exists
    const modalQuantity = document.getElementById('modalQuantity');
    const modalTotal = document.getElementById('modalTotal');
    const paymentAmount = document.getElementById('paymentAmount');
    
    if (modalQuantity) modalQuantity.textContent = quantity;
    if (modalTotal) modalTotal.textContent = total.toFixed(0) + ' сом';
    if (paymentAmount) paymentAmount.textContent = total.toFixed(0) + ' сом';
}

function increaseQuantity() {
    const quantityInput = document.getElementById('quantity');
    quantityInput.value = parseInt(quantityInput.value) + 1;
    updateTotal();
}

function decreaseQuantity() {
    const quantityInput = document.getElementById('quantity');
    if (parseInt(quantityInput.value) > 1) {
        quantityInput.value = parseInt(quantityInput.value) - 1;
        updateTotal();
    }
}

function addToCartFromDetail() {
    const quantity = parseInt(document.getElementById('quantity').value);
    const button = event.target;
    const originalText = button.innerHTML;
    
    // Show loading state
    button.innerHTML = '<i class="bi bi-hourglass-split"></i> Добавляем...';
    button.disabled = true;
    
    fetch('{% url "add_to_cart" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        },
        body: JSON.stringify({
            product_id: {{ product.id }},
            quantity: quantity
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update cart count in navbar
            updateCartCount();
            showMessage(data.message, 'success');
            
            // Change button text temporarily
            button.innerHTML = '<i class="bi bi-check"></i> Добавлено!';
            button.className = 'btn btn-success btn-lg';
            
            setTimeout(() => {
                button.innerHTML = originalText;
                button.className = 'btn btn-outline-primary-custom btn-lg';
                button.disabled = false;
            }, 2000);
        } else {
            showMessage(data.message, 'error');
            button.innerHTML = originalText;
            button.disabled = false;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showMessage('Ошибка при добавлении в корзину', 'error');
        button.innerHTML = originalText;
        button.disabled = false;
    });
}

function toggleFavoriteLocal(productId) {
    {% if user.is_authenticated %}
        const icon = document.getElementById('favorite-icon');
        
        fetch('{% url "toggle_favorite" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            },
            body: JSON.stringify({
                product_id: productId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                if (data.is_favorite) {
                    icon.className = 'bi bi-heart-fill text-danger';
                } else {
                    icon.className = 'bi bi-heart';
                }
                showMessage(data.message, data.is_favorite ? 'success' : 'info');
            } else {
                showMessage(data.message, 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showMessage('Ошибка при обновлении избранного', 'error');
        });
    {% else %}
        showMessage('Войдите в систему, чтобы добавить в избранное', 'warning');
        setTimeout(() => {
            window.location.href = '{% url "login" %}';
        }, 1500);
    {% endif %}
}

function markAsPurchased() {
    fetch('{% url "mark_product_sold" product.pk %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage('Спасибо за покупку! Продажа зафиксирована.', 'success');
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('purchaseModal'));
            if (modal) modal.hide();
        } else {
            showMessage('Ошибка при фиксации продажи', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showMessage('Ошибка при фиксации продажи', 'error');
    });
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    updateTotal();
    
    {% if user.is_authenticated %}
        // Check if product is in favorites
        fetch('{% url "toggle_favorite" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            },
            body: JSON.stringify({
                product_id: {{ product.id }},
                check_only: true
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.is_favorite) {
                document.getElementById('favorite-icon').className = 'bi bi-heart-fill text-danger';
            }
        })
        .catch(error => console.log('Favorite status not loaded'));
    {% endif %}
});
</script>
{% endblock %}