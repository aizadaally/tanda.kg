{% extends 'base.html' %}

{% block title %}{{ product.name }} - Tanda.kg{% endblock %}

{% block content %}
<section class="py-4">
    <div class="container">
        <!-- Breadcrumb -->
        <nav aria-label="breadcrumb" class="mb-4">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'home' %}">Главная</a></li>
                <li class="breadcrumb-item"><a href="{% url 'products' %}">Каталог</a></li>
                <li class="breadcrumb-item"><a href="{% url 'products' %}?category={{ product.category.slug }}">{{ product.category.name }}</a></li>
                <li class="breadcrumb-item active">{{ product.name }}</li>
            </ol>
        </nav>

        <div class="row">
            <!-- Product Images -->
            <div class="col-md-6 mb-4">
                <div class="product-gallery">
                    {% if product.image %}
                        <img src="{{ product.image.url }}" 
                             class="img-fluid rounded shadow-sm" 
                             alt="{{ product.name }}"
                             style="width: 100%; height: 400px; object-fit: cover;">
                    {% else %}
                        <div class="bg-light rounded d-flex align-items-center justify-content-center shadow-sm" 
                             style="height: 400px;">
                            <i class="bi bi-image text-muted" style="font-size: 4rem;"></i>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Product Info -->
            <div class="col-md-6">
                <div class="product-info">
                    <!-- Producer Info -->
                    <div class="mb-3">
                        <a href="{% url 'producer_detail' product.producer.pk %}" class="text-decoration-none">
                            <div class="d-flex align-items-center">
                                {% if product.producer.logo %}
                                    <img src="{{ product.producer.logo.url }}" 
                                         class="rounded-circle me-2" 
                                         width="40" height="40"
                                         alt="{{ product.producer.name }}">
                                {% else %}
                                    <div class="bg-light rounded-circle me-2 d-flex align-items-center justify-content-center" 
                                         style="width: 40px; height: 40px;">
                                        <i class="bi bi-shop"></i>
                                    </div>
                                {% endif %}
                                <div>
                                    <h6 class="mb-0">{{ product.producer.name }}</h6>
                                    <small class="text-muted">{{ product.producer.get_region_display }}</small>
                                    {% if product.producer.is_verified %}
                                        <i class="bi bi-patch-check-fill text-primary ms-1" title="Проверенный производитель"></i>
                                    {% endif %}
                                </div>
                            </div>
                        </a>
                    </div>

                    <!-- Product Name -->
                    <h1 class="h2 mb-3">{{ product.name }}</h1>

                    <!-- Category -->
                    <div class="mb-3">
                        <span class="badge bg-light text-dark">
                            <i class="bi bi-{{ product.category.icon|default:'tag' }}"></i> {{ product.category.name }}
                        </span>
                    </div>

                    <!-- Rating -->
                    {% if product.total_reviews > 0 %}
                    <div class="mb-3">
                        <div class="d-flex align-items-center">
                            <div class="text-warning me-2">
                                {% with rating=product.average_rating %}
                                    {% for i in "12345" %}
                                        {% if forloop.counter <= rating %}
                                            <i class="bi bi-star-fill"></i>
                                        {% else %}
                                            <i class="bi bi-star"></i>
                                        {% endif %}
                                    {% endfor %}
                                {% endwith %}
                            </div>
                            <span class="text-muted">{{ product.average_rating|floatformat:1 }} ({{ product.total_reviews }} отзывов)</span>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Price -->
                    <div class="mb-4">
                        <h3 class="text-primary mb-0">{{ product.price|floatformat:0 }} сом</h3>
                        {% if product.num_sales > 0 %}
                            <small class="text-muted">Куплено: {{ product.num_sales }} раз</small>
                        {% endif %}
                    </div>

                    <!-- Description -->
                    <div class="mb-4">
                        <h5>Описание</h5>
                        <p class="text-muted">{{ product.description|linebreaks }}</p>
                    </div>

                    <!-- Purchase Options -->
                    <div class="purchase-section">
                        <!-- Quantity Selector -->
                        <div class="mb-3">
                            <label class="form-label">Количество:</label>
                            <div class="d-flex align-items-center">
                                <button type="button" class="btn btn-outline-secondary" onclick="decreaseQuantity()">-</button>
                                <input type="number" id="quantity" class="form-control mx-2 text-center" value="1" min="1" style="width: 80px;">
                                <button type="button" class="btn btn-outline-secondary" onclick="increaseQuantity()">+</button>
                            </div>
                        </div>

                        <!-- Total Price -->
                        <div class="mb-3">
                            <h5>Итого: <span id="totalPrice" class="text-primary">{{ product.price|floatformat:0 }}</span> сом</h5>
                        </div>

                        <!-- Buy Button -->
                        <div class="d-grid gap-2 mb-3">
                            {% if user.is_authenticated %}
                                <!-- Add to Cart Button -->
                                <button type="button" 
                                        class="btn btn-outline-primary-custom btn-lg"
                                        onclick="addToCart({{ product.id }})">
                                    <i class="bi bi-bag-plus"></i> Добавить в корзину
                                </button>
                                
                                <!-- QR Purchase Button -->
                                <button type="button" 
                                        class="btn btn-primary-custom btn-lg" 
                                        data-bs-toggle="modal" 
                                        data-bs-target="#purchaseModal">
                                    <i class="bi bi-qr-code-scan"></i> Купить через QR-код
                                </button>
                            {% else %}
                                <a href="{% url 'login' %}?next={{ request.path }}" class="btn btn-primary-custom btn-lg">
                                    <i class="bi bi-box-arrow-in-right"></i> Войти для покупки
                                </a>
                            {% endif %}
                            
                            <button type="button" class="btn btn-outline-secondary" onclick="toggleFavorite({{ product.id }})">
                                <i class="bi bi-heart" id="favorite-icon"></i> В избранное
                            </button>
                        </div>

                        <!-- Contact Producer -->
                        <div class="mt-3 text-center">
                            <small class="text-muted">
                                Есть вопросы? 
                                {% if product.producer.whatsapp_number %}
                                    <a href="https://wa.me/{{ product.producer.whatsapp_number }}" 
                                       target="_blank" 
                                       class="text-decoration-none">
                                        <i class="bi bi-whatsapp text-success"></i> Написать в WhatsApp
                                    </a>
                                {% elif product.producer.phone_number %}
                                    <a href="tel:{{ product.producer.phone_number }}" 
                                       class="text-decoration-none">
                                        <i class="bi bi-phone"></i> Позвонить
                                    </a>
                                {% else %}
                                    <span class="text-muted">Связаться с производителем</span>
                                {% endif %}
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Producer QR Code Modal -->
<div class="modal fade" id="purchaseModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-qr-code-scan text-primary"></i> Оплата через QR-код
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                {% if product.producer.qr_code %}
                    <div class="mb-3">
                        <img src="{{ product.producer.qr_code.url }}" 
                             class="img-fluid border rounded" 
                             alt="QR код для оплаты"
                             style="max-width: 250px;">
                    </div>
                    <h6>{{ product.producer.name }}</h6>
                    <p class="text-muted mb-3">
                        Отсканируйте QR-код через приложение вашего банка
                    </p>
                    
                    <!-- Order Summary -->
                    <div class="border rounded p-3 mb-3 bg-light">
                        <div class="d-flex justify-content-between">
                            <span>{{ product.name }}</span>
                            <span>{{ product.price|floatformat:0 }} сом</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>Количество:</span>
                            <span id="modalQuantity">1</span>
                        </div>
                        <hr class="my-2">
                        <div class="d-flex justify-content-between fw-bold">
                            <span>Итого:</span>
                            <span id="modalTotal">{{ product.price|floatformat:0 }} сом</span>
                        </div>
                    </div>

                    <!-- Payment Instructions -->
                    <div class="alert alert-info text-start">
                        <small>
                            <strong>Как оплатить:</strong><br>
                            1. Откройте приложение банка (MBank, Оптима, Демир и др.)<br>
                            2. Выберите "Оплата по QR" или "Сканер"<br>
                            3. Отсканируйте код выше<br>
                            4. Укажите сумму: <strong id="paymentAmount">{{ product.price|floatformat:0 }} сом</strong><br>
                            5. Подтвердите оплату
                        </small>
                    </div>

                {% else %}
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle"></i>
                        <strong>QR-код недоступен</strong><br>
                        Производитель еще не загрузил QR-код для оплаты.
                        Свяжитесь с ним напрямую для покупки.
                    </div>
                {% endif %}
            </div>
            <div class="modal-footer">
                {% if product.producer.qr_code %}
                    <button type="button" class="btn btn-success" onclick="markAsPurchased()">
                        <i class="bi bi-check-circle"></i> Я оплатил
                    </button>
                {% endif %}
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
            </div>
        </div>
    </div>
</div>

<!-- Reviews Section -->
{% if reviews %}
<section class="py-5 bg-light">
    <div class="container">
        <h3 class="mb-4">Отзывы покупателей</h3>
        <div class="row">
            {% for review in reviews|slice:":6" %}
            <div class="col-md-6 mb-3">
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h6 class="mb-0">{{ review.user.first_name|default:review.user.username }}</h6>
                            <div class="text-warning">
                                {% for i in "12345" %}
                                    {% if forloop.counter <= review.rating %}
                                        <i class="bi bi-star-fill"></i>
                                    {% else %}
                                        <i class="bi bi-star"></i>
                                    {% endif %}
                                {% endfor %}
                            </div>
                        </div>
                        <p class="text-muted mb-1">{{ review.text }}</p>
                        <small class="text-muted">{{ review.created_at|date:"d.m.Y" }}</small>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        
        <!-- Add Review Button -->
        {% if user.is_authenticated %}
            <div class="text-center mt-4">
                <a href="{% url 'add_review' product.pk %}" class="btn btn-outline-primary-custom">
                    <i class="bi bi-plus-circle"></i> Оставить отзыв
                </a>
            </div>
        {% endif %}
    </div>
</section>
{% endif %}

<!-- Similar Products -->
{% if similar_products %}
<section class="py-5">
    <div class="container">
        <h3 class="mb-4">Похожие товары</h3>
        <div class="row">
            {% for product in similar_products %}
            <div class="col-lg-3 col-md-6 mb-4">
                {% include 'frontend/includes/product_card.html' %}
            </div>
            {% endfor %}
        </div>
    </div>
</section>
{% endif %}

<script>
const basePrice = {{ product.price }};

function updateTotal() {
    const quantity = parseInt(document.getElementById('quantity').value);
    const total = basePrice * quantity;
    document.getElementById('totalPrice').textContent = total.toFixed(0);
    
    // Update modal if it exists
    const modalQuantity = document.getElementById('modalQuantity');
    const modalTotal = document.getElementById('modalTotal');
    const paymentAmount = document.getElementById('paymentAmount');
    
    if (modalQuantity) modalQuantity.textContent = quantity;
    if (modalTotal) modalTotal.textContent = total.toFixed(0) + ' сом';
    if (paymentAmount) paymentAmount.textContent = total.toFixed(0) + ' сом';
}

function increaseQuantity() {
    const quantityInput = document.getElementById('quantity');
    quantityInput.value = parseInt(quantityInput.value) + 1;
    updateTotal();
}

function decreaseQuantity() {
    const quantityInput = document.getElementById('quantity');
    if (parseInt(quantityInput.value) > 1) {
        quantityInput.value = parseInt(quantityInput.value) - 1;
        updateTotal();
    }
}

function addToCart(productId) {
    const quantity = parseInt(document.getElementById('quantity').value);
    
    // Send AJAX request to add to cart
    fetch('/cart/add/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        },
        body: JSON.stringify({
            product_id: productId,
            quantity: quantity
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update cart count in navbar
            const cartCount = document.getElementById('cart-count');
            if (cartCount) {
                cartCount.textContent = data.cart_count;
                cartCount.style.display = data.cart_count > 0 ? 'inline' : 'none';
            }
            
            // Show success message
            showMessage('Товар добавлен в корзину!', 'success');
        } else {
            showMessage('Ошибка при добавлении в корзину', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showMessage('Ошибка при добавлении в корзину', 'error');
    });
}

function toggleFavorite(productId) {
    // Send AJAX request to toggle favorite
    fetch('/favorites/toggle/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        },
        body: JSON.stringify({
            product_id: productId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const icon = document.getElementById('favorite-icon');
            if (data.is_favorite) {
                icon.className = 'bi bi-heart-fill text-danger';
                showMessage('Добавлено в избранное!', 'success');
            } else {
                icon.className = 'bi bi-heart';
                showMessage('Удалено из избранного', 'info');
            }
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showMessage('Войдите, чтобы добавить в избранное', 'warning');
    });
}

function markAsPurchased() {
    const quantity = parseInt(document.getElementById('quantity').value);
    
    // Send AJAX request to mark as purchased
    fetch(`/products/ajax/mark-sold/{{ product.pk }}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage('Спасибо за покупку! Продажа зафиксирована.', 'success');
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('purchaseModal'));
            if (modal) modal.hide();
        } else {
            showMessage('Ошибка при фиксации продажи', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showMessage('Ошибка при фиксации продажи', 'error');
    });
}

function showMessage(message, type) {
    // Create and show a toast message
    const toast = document.createElement('div');
    toast.className = `alert alert-${type === 'success' ? 'success' : type === 'error' ? 'danger' : type === 'warning' ? 'warning' : 'info'} alert-dismissible fade show position-fixed`;
    toast.style.cssText = 'top: 100px; right: 20px; z-index: 9999; min-width: 300px;';
    toast.innerHTML = `
        ${message}
        <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
    `;
    document.body.appendChild(toast);
    
    // Auto remove after 3 seconds
    setTimeout(() => {
        if (toast.parentElement) toast.remove();
    }, 3000);
}

// Update total when quantity changes
document.getElementById('quantity').addEventListener('input', updateTotal);

// Load cart count on page load
document.addEventListener('DOMContentLoaded', function() {
    fetch('/cart/count/')
        .then(response => response.json())
        .then(data => {
            const cartCount = document.getElementById('cart-count');
            if (cartCount && data.count > 0) {
                cartCount.textContent = data.count;
                cartCount.style.display = 'inline';
            }
        })
        .catch(error => console.log('Cart count not loaded'));
});
</script>
{% endblock %}