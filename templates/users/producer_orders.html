{% extends 'base.html' %}

{% block title %}Заказы - {{ producer.name }} - Tanda.kg{% endblock %}

{% block content %}
<section class="py-4">
    <div class="container">
        <!-- Header -->
        <div class="row align-items-center mb-4">
            <div class="col-md-8">
                <h1 class="h3">Управление заказами</h1>
                <p class="text-muted">{{ orders.count }} заказов найдено</p>
            </div>
            <div class="col-md-4 text-md-end">
                <a href="{% url 'producer_dashboard' %}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> К панели управления
                </a>
            </div>
        </div>

        <!-- Filters -->
        <div class="row mb-4">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-body">
                        <form method="GET" class="row g-3">
                            <!-- Status Filter -->
                            <div class="col-md-4">
                                <label class="form-label">Статус заказа</label>
                                <select name="status" class="form-select" onchange="this.form.submit()">
                                    <option value="">Все статусы</option>
                                    <option value="pending" {% if status_filter == 'pending' %}selected{% endif %}>Ожидают оплаты</option>
                                    <option value="paid" {% if status_filter == 'paid' %}selected{% endif %}>Оплачены</option>
                                    <option value="completed" {% if status_filter == 'completed' %}selected{% endif %}>Завершены</option>
                                    <option value="cancelled" {% if status_filter == 'cancelled' %}selected{% endif %}>Отменены</option>
                                </select>
                            </div>
                            
                            <!-- Search -->
                            <div class="col-md-6">
                                <label class="form-label">Поиск</label>
                                <input type="text" 
                                       name="search" 
                                       class="form-control" 
                                       placeholder="Поиск по покупателю, товару, телефону..."
                                       value="{{ search_query|default:'' }}">
                            </div>
                            
                            <div class="col-md-2">
                                <label class="form-label">&nbsp;</label>
                                <button type="submit" class="btn btn-primary-custom w-100">
                                    <i class="bi bi-search"></i> Найти
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card bg-light">
                    <div class="card-body text-center">
                        <h6>Быстрые действия</h6>
                        <div class="btn-group-vertical w-100">
                            <button class="btn btn-outline-success btn-sm" onclick="bulkUpdateStatus('paid')">
                                <i class="bi bi-credit-card"></i> Отметить выбранные как оплаченные
                            </button>
                            <button class="btn btn-outline-primary btn-sm" onclick="bulkUpdateStatus('completed')">
                                <i class="bi bi-check-circle"></i> Завершить выбранные
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Orders Table -->
        {% if orders %}
            <div class="card">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>
                                        <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                                    </th>
                                    <th>Заказ</th>
                                    <th>Покупатель</th>
                                    <th>Товар</th>
                                    <th>Количество</th>
                                    <th>Сумма</th>
                                    <th>Статус</th>
                                    <th>Дата</th>
                                    <th>Действия</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for order in orders %}
                                <tr id="order-row-{{ order.id }}">
                                    <td>
                                        <input type="checkbox" class="order-checkbox" value="{{ order.id }}">
                                    </td>
                                    <td>
                                        <strong>#{{ order.id }}</strong>
                                    </td>
                                    <td>
                                        <div>
                                            <strong>{{ order.buyer_name }}</strong>
                                            <br>
                                            <small class="text-muted">{{ order.user.username }}</small>
                                            {% if order.buyer_phone %}
                                                <br><small class="text-muted">{{ order.buyer_phone }}</small>
                                            {% endif %}
                                            {% if order.buyer_email %}
                                                <br><small class="text-muted">{{ order.buyer_email }}</small>
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            {% if order.product.image %}
                                                <img src="{{ order.product.image.url }}" 
                                                     class="rounded me-2" 
                                                     width="40" height="40"
                                                     style="object-fit: cover;"
                                                     alt="{{ order.product.name }}">
                                            {% endif %}
                                            <div>
                                                <strong>{{ order.product.name|truncatechars:40 }}</strong>
                                                <br><small class="text-muted">{{ order.product.price|floatformat:0 }} сом/шт</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <strong>{{ order.quantity }}</strong> шт
                                    </td>
                                    <td>
                                        <strong class="text-primary">{{ order.total_price|floatformat:0 }} сом</strong>
                                    </td>
                                    <td>
                                        <span class="status-badge" id="status-{{ order.id }}">
                                            {% if order.status == 'pending' %}
                                                <span class="badge bg-warning">
                                                    <i class="bi bi-clock"></i> Ожидает оплаты
                                                </span>
                                            {% elif order.status == 'paid' %}
                                                <span class="badge bg-info">
                                                    <i class="bi bi-credit-card"></i> Оплачен
                                                </span>
                                            {% elif order.status == 'completed' %}
                                                <span class="badge bg-success">
                                                    <i class="bi bi-check-circle"></i> Завершен
                                                </span>
                                            {% elif order.status == 'cancelled' %}
                                                <span class="badge bg-danger">
                                                    <i class="bi bi-x-circle"></i> Отменен
                                                </span>
                                            {% endif %}
                                        </span>
                                    </td>
                                    <td>
                                        <small>{{ order.created_at|date:"d.m.Y" }}</small>
                                        <br>
                                        <small class="text-muted">{{ order.created_at|date:"H:i" }}</small>
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            {% if order.status == 'pending' %}
                                                <button class="btn btn-outline-success btn-sm" 
                                                        onclick="updateOrderStatus({{ order.id }}, 'paid')"
                                                        title="Отметить как оплаченный">
                                                    <i class="bi bi-credit-card"></i>
                                                </button>
                                            {% endif %}
                                            {% if order.status == 'paid' %}
                                                <button class="btn btn-outline-primary btn-sm" 
                                                        onclick="updateOrderStatus({{ order.id }}, 'completed')"
                                                        title="Завершить заказ">
                                                    <i class="bi bi-check-circle"></i>
                                                </button>
                                            {% endif %}
                                            {% if order.status in 'pending,paid' %}
                                                <button class="btn btn-outline-danger btn-sm" 
                                                        onclick="updateOrderStatus({{ order.id }}, 'cancelled')"
                                                        title="Отменить заказ">
                                                    <i class="bi bi-x-circle"></i>
                                                </button>
                                            {% endif %}
                                            <div class="btn-group">
                                                <button class="btn btn-outline-secondary btn-sm dropdown-toggle" 
                                                        data-bs-toggle="dropdown">
                                                    <i class="bi bi-telephone"></i>
                                                </button>
                                                <ul class="dropdown-menu">
                                                    {% if order.buyer_phone %}
                                                        <li>
                                                            <a class="dropdown-item" href="tel:{{ order.buyer_phone }}">
                                                                <i class="bi bi-phone"></i> Позвонить
                                                            </a>
                                                        </li>
                                                    {% endif %}
                                                    {% if producer.whatsapp_number %}
                                                        <li>
                                                            <a class="dropdown-item" 
                                                               href="https://wa.me/{{ producer.whatsapp_number }}?text=Здравствуйте! По заказу №{{ order.id }}%0AТовар: {{ order.product.name }}%0AСумма: {{ order.total_price|floatformat:0 }} сом%0A%0AКак дела с заказом?" 
                                                               target="_blank">
                                                                <i class="bi bi-whatsapp"></i> WhatsApp
                                                            </a>
                                                        </li>
                                                    {% endif %}
                                                    <li>
                                                        <a class="dropdown-item" href="{% url 'product_detail' order.product.pk %}" target="_blank">
                                                            <i class="bi bi-eye"></i> Посмотреть товар
                                                        </a>
                                                    </li>
                                                </ul>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        {% else %}
            <!-- No Orders -->
            <div class="text-center py-5">
                <i class="bi bi-inbox" style="font-size: 4rem; color: #dee2e6;"></i>
                <h4 class="mt-3 text-muted">Заказы не найдены</h4>
                {% if status_filter or search_query %}
                    <p class="text-muted">Попробуйте изменить фильтры поиска</p>
                    <a href="{% url 'producer_orders' %}" class="btn btn-outline-primary">
                        <i class="bi bi-arrow-clockwise"></i> Сбросить фильтры
                    </a>
                {% else %}
                    <p class="text-muted">Пока никто не заказывал ваши товары</p>
                    <a href="{% url 'product_add' %}" class="btn btn-primary-custom">
                        <i class="bi bi-plus-circle"></i> Добавить товар
                    </a>
                {% endif %}
            </div>
        {% endif %}
    </div>
</section>

<script>
// CSRF token for AJAX requests
function getCSRFToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
           document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
}

// Select all checkboxes
function toggleSelectAll() {
    const selectAll = document.getElementById('selectAll');
    const checkboxes = document.querySelectorAll('.order-checkbox');
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAll.checked;
    });
}

// Get selected order IDs
function getSelectedOrders() {
    const checkboxes = document.querySelectorAll('.order-checkbox:checked');
    return Array.from(checkboxes).map(cb => cb.value);
}

// Bulk update status
function bulkUpdateStatus(newStatus) {
    const selectedOrders = getSelectedOrders();
    
    if (selectedOrders.length === 0) {
        alert('Выберите заказы для обновления');
        return;
    }
    
    const statusNames = {
        'paid': 'оплаченными',
        'completed': 'завершенными',
        'cancelled': 'отмененными'
    };
    
    if (!confirm(`Отметить ${selectedOrders.length} заказов как ${statusNames[newStatus]}?`)) {
        return;
    }
    
    // Update each selected order
    selectedOrders.forEach(orderId => {
        updateOrderStatus(orderId, newStatus);
    });
    
    // Clear selection
    document.getElementById('selectAll').checked = false;
    toggleSelectAll();
}

// Update single order status
function updateOrderStatus(orderId, newStatus) {
    const statusNames = {
        'pending': 'Ожидает оплаты',
        'paid': 'Оплачен', 
        'completed': 'Завершен',
        'cancelled': 'Отменен'
    };

    // Show loading state
    const row = document.getElementById(`order-row-${orderId}`);
    if (row) {
        row.style.opacity = '0.6';
    }

    fetch('{% url "update_order_status_producer" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken(),
        },
        body: JSON.stringify({
            order_id: orderId,
            status: newStatus
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update status badge
            const statusElement = document.getElementById(`status-${orderId}`);
            if (statusElement) {
                let badgeClass = 'badge ';
                let icon = '';
                switch(newStatus) {
                    case 'pending': 
                        badgeClass += 'bg-warning'; 
                        icon = '<i class="bi bi-clock"></i> ';
                        break;
                    case 'paid': 
                        badgeClass += 'bg-info'; 
                        icon = '<i class="bi bi-credit-card"></i> ';
                        break;
                    case 'completed': 
                        badgeClass += 'bg-success'; 
                        icon = '<i class="bi bi-check-circle"></i> ';
                        break;
                    case 'cancelled': 
                        badgeClass += 'bg-danger'; 
                        icon = '<i class="bi bi-x-circle"></i> ';
                        break;
                }
                statusElement.innerHTML = `<span class="${badgeClass}">${icon}${statusNames[newStatus]}</span>`;
            }

            showMessage(data.message, 'success');
        } else {
            showMessage(data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showMessage('Ошибка при обновлении статуса заказа', 'error');
    })
    .finally(() => {
        if (row) {
            row.style.opacity = '1';
        }
    });
}

// Show message function
function showMessage(message, type) {
    const toast = document.createElement('div');
    toast.className = `alert alert-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'info'} alert-dismissible fade show position-fixed`;
    toast.style.cssText = 'top: 100px; right: 20px; z-index: 9999; min-width: 300px;';
    toast.innerHTML = `
        ${message}
        <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
    `;
    document.body.appendChild(toast);
    
    // Auto remove after 4 seconds
    setTimeout(() => {
        if (toast.parentElement) toast.remove();
    }, 4000);
}

// Auto refresh every 60 seconds
setInterval(() => {
    const currentUrl = new URL(window.location);
    fetch(currentUrl)
        .then(response => response.text())
        .then(html => {
            // Check if there are new orders by comparing table content
            const parser = new DOMParser();
            const newDoc = parser.parseFromString(html, 'text/html');
            const newTable = newDoc.querySelector('.table-responsive');
            const currentTable = document.querySelector('.table-responsive');
            
            if (newTable && currentTable && newTable.innerHTML !== currentTable.innerHTML) {
                showMessage('Обновлены данные о заказах', 'info');
                // Optionally reload the page or update just the table
                setTimeout(() => location.reload(), 2000);
            }
        })
        .catch(error => console.log('Auto refresh failed:', error));
}, 60000); // 60 seconds
</script>
{% endblock %}